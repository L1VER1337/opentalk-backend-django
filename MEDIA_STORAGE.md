# Система хранения медиа-файлов в OpenTalk

## Структура директорий

В проекте OpenTalk медиа-файлы хранятся в директории `/media`, которая находится в корне проекта. Эта директория имеет следующую структуру:

```
media/
├── avatars/          # Аватары пользователей
├── post_media/       # Медиа-файлы в постах (изображения, видео)
├── chat_avatars/     # Аватары групповых чатов
└── message_media/    # Медиа-файлы в сообщениях
```

## Настройки Django

Настройки для медиа-файлов определены в `settings.py`:

```python
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'
```

В режиме разработки (DEBUG = True) Django сервер будет обслуживать медиа-файлы напрямую через URL, начинающиеся с `/media/`.

## Использование в моделях

В моделях Django используются поля `ImageField` или `FileField` для хранения медиа-файлов. Примеры:

### Модель пользователя:
```python
avatar = models.ImageField(_("Аватар"), upload_to='avatars/', null=True, blank=True)
```

### Модель чата:
```python
avatar = models.ImageField(_("Аватар"), upload_to='chat_avatars/', null=True, blank=True)
```

## Обработка медиа в API

Для загрузки медиа-файлов используются два основных подхода:

1. **Прямая загрузка** через API-эндпоинты (для аватаров пользователей, чатов)
2. **Хранение URL** в JSON-структуре (для медиа в постах и сообщениях)

### Хранение URL в JSON

Для полей `media_urls` в моделях `Post` и `Message` используется текстовое поле для хранения списка URL в формате JSON. Это позволяет хранить ссылки на множество медиа-файлов в одной записи.

Пример использования:
```python
# Сохранение
post.set_media_urls(['media/post_media/image1.jpg', 'media/post_media/video1.mp4'])

# Получение
media_list = post.get_media_urls()  # Возвращает список URL
```

## Рекомендации по работе с медиа

1. **Размер файлов**: Ограничивайте размер загружаемых файлов (рекомендуется до 10 МБ для изображений и до 100 МБ для видео)
2. **Форматы**: Поддерживайте только безопасные форматы (JPEG, PNG, GIF для изображений; MP4, WebM для видео)
3. **Валидация**: Всегда проверяйте MIME-тип загружаемых файлов для безопасности
4. **Оптимизация**: Для продакшн-окружения рекомендуется использовать CDN и оптимизировать изображения

## Продакшн-окружение

В продакшн-окружении рекомендуется:
1. Использовать внешние хранилища (AWS S3, Google Cloud Storage)
2. Настроить CDN для быстрой доставки медиа-контента
3. Использовать django-storages для интеграции с облачными хранилищами

Пример настройки с AWS S3:
```python
INSTALLED_APPS += ['storages']

AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
AWS_STORAGE_BUCKET_NAME = os.environ.get('AWS_STORAGE_BUCKET_NAME')

DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
``` 